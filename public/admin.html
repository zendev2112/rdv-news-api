<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RDV News - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-group .btn {
            margin-top: 0;
        }

        .input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
        }

        .log-success {
            color: #10b981;
        }

        .log-error {
            color: #ef4444;
        }

        .log-warning {
            color: #f59e0b;
        }

        .log-info {
            color: #3b82f6;
        }

        .log-debug {
            color: #8b5cf6;
        }

        .log-timestamp {
            color: #64748b;
            margin-right: 8px;
        }

        .log-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-idle {
            background: #e5e7eb;
            color: #6b7280;
        }

        .status-running {
            background: #dbeafe;
            color: #2563eb;
        }

        .status-success {
            background: #d1fae5;
            color: #059669;
        }

        .status-error {
            background: #fee2e2;
            color: #dc2626;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: #667eea;
            width: 0%;
            transition: width 0.3s;
            animation: progress 2s ease-in-out infinite;
        }

        @keyframes progress {
            0% {
                width: 0%;
            }

            50% {
                width: 100%;
            }

            100% {
                width: 0%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üóûÔ∏è RDV News Admin Panel</h1>
            <p class="subtitle">Manual article fetching and processing with Gemini AI</p>
        </div>

        <div class="card" style="margin-bottom: 20px;">
            <h3>üîê Authentication</h3>
            <input type="password" class="input" id="apiToken" placeholder="Enter API token">
            <button class="btn btn-success" onclick="saveToken()">Save Token</button>
        </div>

        <div class="grid">
            <div class="card">
                <h3>üì∞ Fetch All Sections <span class="status status-idle" id="status-all">Idle</span></h3>
                <input type="number" class="input" id="limit-all" value="10" min="1" max="50"
                    placeholder="Articles per section">
                <div class="btn-group">
                    <button class="btn btn-primary" id="btn-all" onclick="fetchAll()">Fetch All Sections</button>
                    <button class="btn btn-danger" id="btn-cancel-all" onclick="cancelFetch('all')"
                        style="display:none;">Cancel</button>
                </div>
                <div class="progress-bar" id="progress-all" style="display:none;">
                    <div class="progress-bar-fill"></div>
                </div>
            </div>

            <div class="card">
                <h3>üìã Fetch Specific Section <span class="status status-idle" id="status-section">Idle</span></h3>
                <select class="input" id="section-select">
                    <option value="primera-plana">Primera Plana</option>
                    <option value="coronel-suarez">Coronel Su√°rez</option>
                    <option value="local">Local</option>
                    <option value="local-facebook">Local Facebook</option>
                    <option value="pueblos-alemanes">Pueblos Alemanes</option>
                    <option value="huanguelen">Huanguel√©n</option>
                    <option value="la-sexta">La Sexta</option>
                    <option value="instituciones">Instituciones</option>
                    <option value="politica">Pol√≠tica</option>
                    <option value="economia">Econom√≠a</option>
                    <option value="agro">Agro</option>
                    <option value="salud">Salud</option>
                    <option value="cultura">Cultura</option>
                    <option value="ciencia">Ciencia</option>
                    <option value="cine-series">Cine y Series</option>
                    <option value="historia-literatura">Historia y Literatura</option>
                    <option value="lifestyle">Lifestyle</option>
                    <option value="turismo">Turismo</option>
                    <option value="recetaS">Recetas</option>
                </select>
                <input type="number" class="input" id="limit-section" value="10" min="1" max="50"
                    placeholder="Articles limit">
                <div class="btn-group">
                    <button class="btn btn-primary" id="btn-section" onclick="fetchSection()">Fetch Section</button>
                    <button class="btn btn-danger" id="btn-cancel-section" onclick="cancelFetch('section')"
                        style="display:none;">Cancel</button>
                </div>
                <div class="progress-bar" id="progress-section" style="display:none;">
                    <div class="progress-bar-fill"></div>
                </div>
            </div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">üìä Live Console Logs</h3>
                <div class="log-controls">
                    <button class="btn btn-primary" style="width: auto; padding: 8px 16px; margin: 0;"
                        onclick="clearLogs()">Clear Logs</button>
                    <button class="btn btn-success" style="width: auto; padding: 8px 16px; margin: 0;"
                        onclick="downloadLogs()">Download Logs</button>
                </div>
            </div>
            <div class="log" id="logs">
                <div class="log-entry log-info">üöÄ Admin panel ready. Enter your API token to begin.</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let API_TOKEN = localStorage.getItem('rdv_api_token') || '';
        let currentController = null;
        let allLogs = [];

        if (API_TOKEN) {
            document.getElementById('apiToken').value = API_TOKEN;
            addLog('‚úÖ API token loaded from storage', 'success');
        }

        function saveToken() {
            API_TOKEN = document.getElementById('apiToken').value;
            localStorage.setItem('rdv_api_token', API_TOKEN);
            addLog('‚úÖ API token saved', 'success');
        }

        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;

            const timestamp = new Date().toLocaleTimeString();
            const timestampSpan = document.createElement('span');
            timestampSpan.className = 'log-timestamp';
            timestampSpan.textContent = `[${timestamp}]`;

            entry.appendChild(timestampSpan);
            entry.appendChild(document.createTextNode(` ${message}`));

            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;

            allLogs.push({ timestamp, message, type });
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '<div class="log-entry log-info">üìã Logs cleared</div>';
            allLogs = [];
        }

        function downloadLogs() {
            const logText = allLogs.map(log => `[${log.timestamp}] ${log.message}`).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rdv-logs-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function setStatus(id, status, text) {
            const el = document.getElementById(id);
            el.className = `status status-${status}`;
            el.textContent = text;
        }

        function showProgress(id, show) {
            document.getElementById(`progress-${id}`).style.display = show ? 'block' : 'none';
        }

        function showCancelButton(id, show) {
            document.getElementById(`btn-cancel-${id}`).style.display = show ? 'block' : 'none';
            document.getElementById(`btn-${id}`).style.display = show ? 'none' : 'block';
        }

        function cancelFetch(type) {
            if (currentController) {
                currentController.abort();
                addLog(`‚ö†Ô∏è Fetch cancelled by user`, 'warning');
                setStatus(`status-${type}`, 'idle', 'Cancelled');
                showProgress(type, false);
                showCancelButton(type, false);
            }
        }

        function parseLogLine(line) {
            line = line.trim();
            if (!line) return null;

            // Detect log type
            let type = 'info';
            if (line.includes('‚úÖ') || line.includes('SUCCESS')) type = 'success';
            else if (line.includes('‚ùå') || line.includes('ERROR')) type = 'error';
            else if (line.includes('‚ö†Ô∏è') || line.includes('WARN')) type = 'warning';
            else if (line.includes('üîç') || line.includes('DEBUG')) type = 'debug';

            return { message: line, type };
        }

        async function fetchSection() {
            if (!API_TOKEN) {
                addLog('‚ùå Please enter API token first', 'error');
                return;
            }

            const section = document.getElementById('section-select').value;
            const limit = document.getElementById('limit-section').value;
            setStatus('status-section', 'running', 'Running');
            showProgress('section', true);
            showCancelButton('section', true);

            addLog(`üì• Starting fetch for section: ${section} (limit: ${limit})...`, 'info');

            currentController = new AbortController();

            try {
                const response = await fetch(`${API_BASE}/api/fetch/section`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_TOKEN}`
                    },
                    body: JSON.stringify({
                        section,
                        limit: parseInt(limit)
                    }),
                    signal: currentController.signal
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));

                                if (data.type === 'log') {
                                    const parsed = parseLogLine(data.message);
                                    if (parsed) {
                                        addLog(parsed.message, parsed.type);
                                    }
                                } else if (data.type === 'error') {
                                    addLog(data.message, 'error');
                                } else if (data.type === 'complete') {
                                    if (data.success) {
                                        addLog(`‚úÖ Fetch completed for ${section}!`, 'success');
                                        setStatus('status-section', 'success', 'Success');
                                    } else {
                                        addLog(`‚ùå Fetch failed with code ${data.code}`, 'error');
                                        setStatus('status-section', 'error', 'Error');
                                    }
                                }
                            } catch (e) {
                                console.error('Parse error:', e);
                            }
                        }
                    }
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    addLog(`‚ö†Ô∏è Fetch cancelled`, 'warning');
                    setStatus('status-section', 'idle', 'Cancelled');
                } else {
                    addLog(`‚ùå Request failed: ${error.message}`, 'error');
                    setStatus('status-section', 'error', 'Error');
                }
            } finally {
                showProgress('section', false);
                showCancelButton('section', false);
                currentController = null;
                setTimeout(() => setStatus('status-section', 'idle', 'Idle'), 3000);
            }
        }

        async function fetchAll() {
            if (!API_TOKEN) {
                addLog('‚ùå Please enter API token first', 'error');
                return;
            }

            const limit = document.getElementById('limit-all').value;
            setStatus('status-all', 'running', 'Running');
            showProgress('all', true);
            showCancelButton('all', true);

            addLog(`üì• Starting fetch for ALL sections (limit: ${limit} per section)...`, 'info');

            currentController = new AbortController();

            try {
                const response = await fetch(`${API_BASE}/api/fetch/all`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_TOKEN}`
                    },
                    body: JSON.stringify({ limit: parseInt(limit) }),
                    signal: currentController.signal
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));

                                if (data.type === 'log') {
                                    const parsed = parseLogLine(data.message);
                                    if (parsed) {
                                        addLog(parsed.message, parsed.type);
                                    }
                                } else if (data.type === 'error') {
                                    addLog(data.message, 'error');
                                } else if (data.type === 'complete') {
                                    if (data.success) {
                                        addLog(`‚úÖ Fetch all completed successfully!`, 'success');
                                        setStatus('status-all', 'success', 'Success');
                                    } else {
                                        addLog(`‚ùå Fetch failed with code ${data.code}`, 'error');
                                        setStatus('status-all', 'error', 'Error');
                                    }
                                }
                            } catch (e) {
                                console.error('Parse error:', e);
                            }
                        }
                    }
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    addLog(`‚ö†Ô∏è Fetch cancelled`, 'warning');
                    setStatus('status-all', 'idle', 'Cancelled');
                } else {
                    addLog(`‚ùå Request failed: ${error.message}`, 'error');
                    setStatus('status-all', 'error', 'Error');
                }
            } finally {
                showProgress('all', false);
                showCancelButton('all', false);
                currentController = null;
                setTimeout(() => setStatus('status-all', 'idle', 'Idle'), 3000);
            }
        }
    </script>
</body>

</html>